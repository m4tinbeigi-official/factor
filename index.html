<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙØ§Ú©ØªÙˆØ± Ø³Ø§Ø² Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ | Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ù‡ÙˆØ´Ù…Ù†Ø¯</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { --primary: #2c3e50; --bg-panel: #f1f2f6; --border-color: #dfe4ea; }
        body, input, textarea, select, button, table, span, div, h1, h2, h3 { font-family: 'Vazirmatn', sans-serif !important; }
        body { margin: 0; display: flex; height: 100vh; background: #ced6e0; overflow: hidden; }

        /* --- Ù†ÙˆØ§Ø± Ú©Ù†Ø§Ø±ÛŒ (Ø³Ù…Øª Ø±Ø§Ø³Øª Ø¨Ø±Ø§ÛŒ Ø¢Ø±Ø´ÛŒÙˆ Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª) --- */
        aside.sidebar {
            width: 360px; background: #fff; display: flex; flex-direction: column;
            border-left: 1px solid #ccc; z-index: 10; box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        
        .sidebar-header { padding: 15px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 15px; }

        details { border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 8px; background: #fff; }
        summary { padding: 10px; cursor: pointer; font-weight: bold; font-size: 13px; background: #f8f9fa; display: flex; justify-content: space-between; }
        .details-body { padding: 15px; border-top: 1px solid var(--border-color); }

        .form-group { margin-bottom: 10px; }
        .row { display: flex; gap: 8px; }
        .col { flex: 1; }
        
        label { display: block; font-size: 11px; font-weight: 600; color: #57606f; margin-bottom: 4px; }
        input, textarea, select { width: 100%; padding: 8px; border: 1px solid #a4b0be; border-radius: 4px; font-size: 12px; box-sizing: border-box; }

        .btn { border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; display: inline-flex; align-items: center; gap: 5px; justify-content: center; transition: 0.3s; }
        .btn-block { width: 100%; margin-top: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: #ff4757; color: white; }
        .btn-success { background: #2ed573; color: white; }
        .btn-warning { background: #ffa502; color: white; }
        .btn-outline { border: 1px solid #ccc; background: white; }

        /* Ø¨Ø®Ø´ Ø¢Ø±Ø´ÛŒÙˆ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ */
        .archive-list { margin-top: 10px; border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; }
        .archive-item { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 11px; }
        .archive-item:hover { background: #f1f2f6; cursor: pointer; }
        .archive-item .actions { display: flex; gap: 5px; }

        /* Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ± */
        main.preview-area { flex: 1; overflow-y: auto; padding: 30px; display: flex; justify-content: center; }
        .paper { width: 210mm; min-height: 297mm; background: white; padding: 10mm; box-shadow: 0 5px 20px rgba(0,0,0,0.15); position: relative; }

        /* Ø§Ù…Ø¶Ø§ */
        .sig-box { width: 48%; min-height: 100px; border: 1px solid #000; padding: 5px; font-size: 11px; position: relative; }
        .signature-img { position: absolute; bottom: 5px; right: 5px; max-height: 70px; mix-blend-mode: multiply; }

        .item-row-control { background: #f9f9f9; padding: 8px; border: 1px solid #eee; margin-bottom: 5px; position: relative; }
        
        .invoice-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--primary); padding-bottom: 10px; margin-bottom: 15px; }
        .inv-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        .inv-table th, .inv-table td { border: 1px solid #000; padding: 6px; text-align: center; }
        .inv-table th { background: #f1f2f6; }

        @media print {
            aside.sidebar { display: none !important; }
            body { background: white; }
            main.preview-area { padding: 0; }
            .paper { box-shadow: none; margin: 0; }
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">
            <h3>Ù…Ø¯ÛŒØ±ÛŒØª ÙØ§Ú©ØªÙˆØ±</h3>
            <span class="material-icons">description</span>
        </div>
        <div class="sidebar-content">
            
            <details open>
                <summary>ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ <span class="material-icons" style="font-size:16px">inventory_2</span></summary>
                <div class="details-body" style="padding: 5px;">
                    <div id="archive_container" class="archive-list">
                        </div>
                </div>
            </details>

            <details>
                <summary>Ù…Ø´Ø®ØµØ§Øª ÙØ±ÙˆØ´Ù†Ø¯Ù‡ (Ø«Ø§Ø¨Øª) <span class="material-icons" style="font-size:16px">store</span></summary>
                <div class="details-body">
                    <div class="form-group"><label>Ù†Ø§Ù… Ø´Ø±Ú©Øª/ÙØ±ÙˆØ´Ù†Ø¯Ù‡</label><input type="text" id="inp_s_name" oninput="saveSellerInfo()"></div>
                    <div class="form-group"><label>Ø¢Ø¯Ø±Ø³</label><textarea id="inp_s_addr" oninput="saveSellerInfo()"></textarea></div>
                    <div class="row">
                        <div class="col"><label>ØªÙ„ÙÙ†</label><input type="text" id="inp_s_tel" oninput="saveSellerInfo()"></div>
                        <div class="col"><label>Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ</label><input type="text" id="inp_s_eco" oninput="saveSellerInfo()"></div>
                    </div>
                    <button class="btn btn-danger btn-block" onclick="clearSellerInfo()">Ø­Ø°Ù Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø«Ø§Ø¨Øª ÙØ±ÙˆØ´Ù†Ø¯Ù‡</button>
                </div>
            </details>

            <details open>
                <summary>Ù…Ø´Ø®ØµØ§Øª Ù…Ø´ØªØ±ÛŒ Ùˆ ÙØ§Ú©ØªÙˆØ± <span class="material-icons" style="font-size:16px">person</span></summary>
                <div class="details-body">
                    <div class="form-group"><label>Ù†Ø§Ù… Ø®Ø±ÛŒØ¯Ø§Ø± (Ù†Ø§Ù… ÙØ§Ú©ØªÙˆØ±)</label><input type="text" id="inp_b_name" oninput="save()"></div>
                    <div class="row">
                        <div class="col"><label>Ø³Ø±ÛŒØ§Ù„</label><input type="text" id="inp_serial" oninput="save()"></div>
                        <div class="col"><label>ØªØ§Ø±ÛŒØ®</label><input type="text" id="inp_date" oninput="save()"></div>
                    </div>
                </div>
            </details>

            <details>
                <summary>Ø§Ù‚Ù„Ø§Ù… ÙØ§Ú©ØªÙˆØ± <span class="material-icons" style="font-size:16px">shopping_cart</span></summary>
                <div class="details-body" id="items_control_container"></div>
                <button class="btn btn-primary btn-block" onclick="addItem()">+ Ø§ÙØ²ÙˆØ¯Ù† Ø±Ø¯ÛŒÙ</button>
            </details>

            <details>
                <summary>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ùˆ Ø§Ù…Ø¶Ø§Ø¡ <span class="material-icons" style="font-size:16px">draw</span></summary>
                <div class="details-body">
                    <div class="form-group">
                        <label>Ø§Ù†ØªØ®Ø§Ø¨ ØªØµÙˆÛŒØ± Ø§Ù…Ø¶Ø§Ø¡:</label>
                        <input type="file" accept="image/*" onchange="uploadSignature(this)">
                    </div>
                    <div class="form-group">
                        <label>Ø±Ù†Ú¯ ÙØ§Ú©ØªÙˆØ±:</label>
                        <input type="color" id="inp_color" value="#2c3e50" onchange="updateTheme()">
                    </div>
                </div>
            </details>

            <div style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                <div class="row">
                    <button class="btn btn-success col" onclick="exportAsImage()">Ø®Ø±ÙˆØ¬ÛŒ ØªØµÙˆÛŒØ± (PNG)</button>
                    <button class="btn btn-primary col" onclick="window.print()">Ú†Ø§Ù¾ / PDF</button>
                </div>
                <button class="btn btn-danger btn-block" onclick="resetCurrentInvoice()">Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ùˆ Ø¢Ø±Ø´ÛŒÙˆ ÙØ§Ú©ØªÙˆØ± Ø¬Ø§Ø±ÛŒ</button>
            </div>
        </div>
    </aside>

    <main class="preview-area">
        <div class="paper" id="invoice_paper">
            <div class="invoice-header">
                <div style="width: 150px;">
                    <div id="out_logo_placeholder" style="font-size: 10px; color: #ccc;">Ù…Ø­Ù„ Ù…Ù‡Ø±</div>
                </div>
                <div style="text-align: center;">
                    <h1 id="out_inv_title" style="margin:0; color:var(--primary);">ØµÙˆØ±ØªØ­Ø³Ø§Ø¨ ÙØ±ÙˆØ´ Ú©Ø§Ù„Ø§ Ùˆ Ø®Ø¯Ù…Ø§Øª</h1>
                    <small>Ù†Ø³Ø®Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¢Ø±Ø´ÛŒÙˆÛŒ</small>
                </div>
                <div style="font-size: 11px; text-align: left; width: 150px;">
                    <div>Ø´Ù…Ø§Ø±Ù‡: <span id="out_serial"></span></div>
                    <div>ØªØ§Ø±ÛŒØ®: <span id="out_date"></span></div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <div style="flex: 1; border: 1px solid #000; padding: 5px; border-radius: 4px;">
                    <strong style="font-size: 12px; display: block; border-bottom: 1px solid #eee; margin-bottom: 5px;">ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</strong>
                    <div style="font-size: 11px;">Ù†Ø§Ù…: <span id="out_s_name"></span> | ØªÙ„ÙÙ†: <span id="out_s_tel"></span></div>
                    <div style="font-size: 11px;">Ø¢Ø¯Ø±Ø³: <span id="out_s_addr"></span></div>
                </div>
                <div style="flex: 1; border: 1px solid #000; padding: 5px; border-radius: 4px;">
                    <strong style="font-size: 12px; display: block; border-bottom: 1px solid #eee; margin-bottom: 5px;">Ø®Ø±ÛŒØ¯Ø§Ø±:</strong>
                    <div style="font-size: 11px;">Ù†Ø§Ù…/Ø´Ø±Ú©Øª: <span id="out_b_name" style="font-weight: bold;"></span></div>
                    <div style="font-size: 11px;">Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ/Ù…Ù„ÛŒ: <span id="out_b_eco"></span></div>
                </div>
            </div>

            <table class="inv-table">
                <thead>
                    <tr>
                        <th width="5%">Ø±Ø¯ÛŒÙ</th>
                        <th>Ø´Ø±Ø­ Ú©Ø§Ù„Ø§</th>
                        <th width="10%">ØªØ¹Ø¯Ø§Ø¯</th>
                        <th width="15%">ÙÛŒ (Ø±ÛŒØ§Ù„)</th>
                        <th width="20%">Ø¬Ù…Ø¹ Ú©Ù„</th>
                    </tr>
                </thead>
                <tbody id="out_tbody"></tbody>
                <tfoot>
                    <tr style="background: #eee; font-weight: bold;">
                        <td colspan="4" style="text-align: left; padding: 10px;">Ø¬Ù…Ø¹ Ú©Ù„ Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª (Ø±ÛŒØ§Ù„):</td>
                        <td id="out_final_val">0</td>
                    </tr>
                </tfoot>
            </table>

            <div style="margin-top: 15px; border: 1px solid #000; padding: 10px; font-size: 12px; border-radius: 4px;">
                Ù…Ø¨Ù„Øº Ø¨Ù‡ Ø­Ø±ÙˆÙ: <span id="out_words_text"></span> Ø±ÛŒØ§Ù„
            </div>

            <div style="display: flex; justify-content: space-between; margin-top: 40px;">
                <div class="sig-box">
                    Ù…Ù‡Ø± Ùˆ Ø§Ù…Ø¶Ø§Ø¡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡:
                    <img id="out_sig_img" class="signature-img" src="" style="display:none;">
                </div>
                <div class="sig-box">Ù…Ù‡Ø± Ùˆ Ø§Ù…Ø¶Ø§Ø¡ Ø®Ø±ÛŒØ¯Ø§Ø±:</div>
            </div>
        </div>
    </main>

    <script>
        // Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        let state = {
            serial: '1001',
            date: '',
            buyerName: '',
            items: [],
            signature: null,
            themeColor: '#2c3e50'
        };

        // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø«Ø§Ø¨Øª ÙØ±ÙˆØ´Ù†Ø¯Ù‡
        let sellerInfo = { name: '', addr: '', tel: '', eco: '' };

        // Ù„ÛŒØ³Øª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø¢Ø±Ø´ÛŒÙˆ Ø´Ø¯Ù‡
        let archive = [];

        function init() {
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ù†Ø¯Ù‡
            const savedSeller = localStorage.getItem('fixed_seller_info');
            if (savedSeller) {
                sellerInfo = JSON.parse(savedSeller);
                Object.keys(sellerInfo).forEach(key => {
                    if(document.getElementById('inp_s_' + key))
                        document.getElementById('inp_s_' + key).value = sellerInfo[key];
                });
            }

            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§Ú©ØªÙˆØ± Ø¬Ø§Ø±ÛŒ
            const savedState = localStorage.getItem('current_invoice_state');
            if (savedState) state = JSON.parse(savedState);
            else addItem();

            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ø±Ø´ÛŒÙˆ
            const savedArchive = localStorage.getItem('invoice_archive');
            if (savedArchive) archive = JSON.parse(savedArchive);

            updateTheme();
            renderArchive();
            renderSidebarItems();
            render();
        }

        function save() {
            state.buyerName = document.getElementById('inp_b_name').value;
            state.serial = document.getElementById('inp_serial').value;
            state.date = document.getElementById('inp_date').value;
            state.themeColor = document.getElementById('inp_color').value;
            localStorage.setItem('current_invoice_state', JSON.stringify(state));
            render();
        }

        function saveSellerInfo() {
            sellerInfo.name = document.getElementById('inp_s_name').value;
            sellerInfo.addr = document.getElementById('inp_s_addr').value;
            sellerInfo.tel = document.getElementById('inp_s_tel').value;
            sellerInfo.eco = document.getElementById('inp_s_eco').value;
            localStorage.setItem('fixed_seller_info', JSON.stringify(sellerInfo));
            render();
        }

        function clearSellerInfo() {
            if(confirm('Ø¢ÛŒØ§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø«Ø§Ø¨Øª ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) {
                localStorage.removeItem('fixed_seller_info');
                location.reload();
            }
        }

        function addItem() {
            state.items.push({ desc: '', qty: 1, price: 0 });
            renderSidebarItems();
            save();
        }

        function removeItem(idx) {
            state.items.splice(idx, 1);
            renderSidebarItems();
            save();
        }

        function updateItem(idx, key, val) {
            state.items[idx][key] = val;
            save();
        }

        function renderSidebarItems() {
            const container = document.getElementById('items_control_container');
            container.innerHTML = '';
            state.items.forEach((item, idx) => {
                container.innerHTML += `
                    <div class="item-row-control">
                        <span class="material-icons" style="position:absolute; left:5px; color:red; cursor:pointer;" onclick="removeItem(${idx})">delete</span>
                        <input type="text" placeholder="Ø´Ø±Ø­ Ú©Ø§Ù„Ø§" value="${item.desc}" oninput="updateItem(${idx}, 'desc', this.value)" style="width:85%; margin-bottom:5px;">
                        <div class="row">
                            <input type="number" placeholder="ØªØ¹Ø¯Ø§Ø¯" class="col" value="${item.qty}" oninput="updateItem(${idx}, 'qty', this.value)">
                            <input type="number" placeholder="ÙÛŒ" class="col" value="${item.price}" oninput="updateItem(${idx}, 'price', this.value)">
                        </div>
                    </div>`;
            });
        }

        function render() {
            // ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡
            document.getElementById('out_s_name').innerText = sellerInfo.name;
            document.getElementById('out_s_addr').innerText = sellerInfo.addr;
            document.getElementById('out_s_tel').innerText = sellerInfo.tel;
            
            // ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù…Ø´ØªØ±ÛŒ
            document.getElementById('out_b_name').innerText = state.buyerName;
            document.getElementById('out_serial').innerText = state.serial;
            document.getElementById('out_date').innerText = state.date;

            // Ø¬Ø¯ÙˆÙ„ Ø§Ù‚Ù„Ø§Ù…
            const tbody = document.getElementById('out_tbody');
            tbody.innerHTML = '';
            let total = 0;

            state.items.forEach((item, i) => {
                let rowTotal = item.qty * item.price;
                total += rowTotal;
                tbody.innerHTML += `
                    <tr>
                        <td>${i+1}</td>
                        <td style="text-align:right">${item.desc}</td>
                        <td>${item.qty}</td>
                        <td>${Number(item.price).toLocaleString()}</td>
                        <td>${rowTotal.toLocaleString()}</td>
                    </tr>`;
            });

            document.getElementById('out_final_val').innerText = total.toLocaleString();
            document.getElementById('out_words_text').innerText = numToPersianWords(total);
            
            if(state.signature) {
                document.getElementById('out_sig_img').src = state.signature;
                document.getElementById('out_sig_img').style.display = 'block';
            }
        }

        // Ø³ÛŒØ³ØªÙ… Ø¢Ø±Ø´ÛŒÙˆ Ùˆ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ
        function resetCurrentInvoice() {
            if(!state.buyerName) { alert('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø®Ø±ÛŒØ¯Ø§Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ØªØ§ ÙØ§Ú©ØªÙˆØ± Ø¢Ø±Ø´ÛŒÙˆ Ø´ÙˆØ¯.'); return; }
            
            // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø¢Ø±Ø´ÛŒÙˆ
            const archiveEntry = {
                id: Date.now(),
                name: state.buyerName,
                date: state.date,
                data: JSON.parse(JSON.stringify(state))
            };
            archive.push(archiveEntry);
            localStorage.setItem('invoice_archive', JSON.stringify(archive));

            // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙØ§Ú©ØªÙˆØ± ÙØ¹Ù„ÛŒ (Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù ÙØ±ÙˆØ´Ù†Ø¯Ù‡)
            state.items = [{ desc: '', qty: 1, price: 0 }];
            state.buyerName = '';
            state.serial = (parseInt(state.serial) + 1).toString();
            save();
            renderArchive();
            renderSidebarItems();
            alert('ÙØ§Ú©ØªÙˆØ± Ø¬Ø§Ø±ÛŒ Ø¢Ø±Ø´ÛŒÙˆ Ùˆ ÙØ±Ù… Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø´Ø¯.');
        }

        function renderArchive() {
            const container = document.getElementById('archive_container');
            container.innerHTML = archive.length === 0 ? '<div style="padding:10px; color:#999;">Ø¢Ø±Ø´ÛŒÙˆ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</div>' : '';
            archive.forEach(item => {
                container.innerHTML += `
                    <div class="archive-item">
                        <span onclick="loadArchive(${item.id})">ğŸ¢ ${item.name} (${item.date})</span>
                        <div class="actions">
                            <span class="material-icons" style="font-size:16px; color:red; cursor:pointer;" onclick="deleteArchive(${item.id})">delete</span>
                        </div>
                    </div>`;
            });
        }

        function loadArchive(id) {
            const entry = archive.find(a => a.id === id);
            if(entry) {
                state = JSON.parse(JSON.stringify(entry.data));
                renderSidebarItems();
                render();
                // Ø¢Ù¾Ø¯ÛŒØª Ø§ÛŒÙ†Ù¾ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ø³Ø§ÛŒØ¯Ø¨Ø§Ø±
                document.getElementById('inp_b_name').value = state.buyerName;
                document.getElementById('inp_serial').value = state.serial;
                document.getElementById('inp_date').value = state.date;
                alert('ÙØ§Ú©ØªÙˆØ± Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ ' + entry.name + ' Ù„ÙˆØ¯ Ø´Ø¯.');
            }
        }

        function deleteArchive(id) {
            if(confirm('Ø§ÛŒÙ† ÙØ§Ú©ØªÙˆØ± Ø§Ø² Ø¢Ø±Ø´ÛŒÙˆ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) {
                archive = archive.filter(a => a.id !== id);
                localStorage.setItem('invoice_archive', JSON.stringify(archive));
                renderArchive();
            }
        }

        // Ø®Ø±ÙˆØ¬ÛŒ ØªØµÙˆÛŒØ±
        function exportAsImage() {
            const filename = (state.buyerName || 'ÙØ§Ú©ØªÙˆØ±') + '.png';
            html2canvas(document.getElementById('invoice_paper'), { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL("image/png");
                link.click();
            });
        }

        function uploadSignature(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) { 
                    state.signature = e.target.result; 
                    save(); 
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateTheme() {
            const color = document.getElementById('inp_color').value;
            document.documentElement.style.setProperty('--primary', color);
            save();
        }

        // ØªØ¨Ø¯ÛŒÙ„ Ø¹Ø¯Ø¯ Ø¨Ù‡ Ø­Ø±ÙˆÙ (Ø³Ø§Ø¯Ù‡ Ø´Ø¯Ù‡)
        function numToPersianWords(number) {
            if (number === 0) return 'ØµÙØ±';
            const units = ['', 'Ù‡Ø²Ø§Ø±', 'Ù…ÛŒÙ„ÛŒÙˆÙ†', 'Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯'];
            // Ø§ÛŒÙ† ÛŒÚ© ØªØ§Ø¨Ø¹ Ø³Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª - Ø¨Ø±Ø§ÛŒ Ø¯Ù‚Øª Û±Û°Û°Ùª Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯
            return number.toLocaleString('fa-IR'); 
        }

        window.onload = init;
    </script>
</body>
</html>
