<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فاکتور رسمی هوشمند | نسخه نهایی</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2c3e50;
            --bg-panel: #f1f2f6;
            --border-color: #dfe4ea;
        }

        /* --- تنظیمات فونت سراسری و اجباری --- */
        body, input, textarea, select, button, table, span, div {
            font-family: 'Vazirmatn', sans-serif !important;
        }

        body {
            margin: 0; display: flex; height: 100vh; background: #ced6e0; overflow: hidden;
        }

        /* --- استایل نوار تنظیمات (Sidebar) --- */
        aside.sidebar {
            width: 360px; background: #fff; display: flex; flex-direction: column;
            border-left: 1px solid #ccc; z-index: 10; box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        
        .sidebar-header {
            padding: 15px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center;
        }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 15px; }

        details {
            border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 8px; background: #fff; overflow: hidden;
        }
        summary {
            padding: 10px 15px; cursor: pointer; font-weight: bold; font-size: 13px; background: #f8f9fa;
            user-select: none; display: flex; justify-content: space-between; align-items: center;
        }
        summary:hover { background: #e9ecef; }
        .details-body { padding: 15px; border-top: 1px solid var(--border-color); }

        .form-group { margin-bottom: 10px; }
        .row { display: flex; gap: 8px; }
        .col { flex: 1; }
        
        label { display: block; font-size: 11px; font-weight: 500; color: #57606f; margin-bottom: 4px; }
        input, textarea, select {
            width: 100%; padding: 8px; border: 1px solid #a4b0be; border-radius: 4px;
            font-size: 12px; box-sizing: border-box; transition: 0.2s;
        }
        input:focus { border-color: var(--primary); outline: none; }

        .btn {
            border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;
            font-size: 13px; display: inline-flex; align-items: center; gap: 5px; justify-content: center;
        }
        .btn-block { width: 100%; display: flex; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: #ff4757; color: white; }
        .btn-success { background: #2ed573; color: white; }
        .btn-outline { border: 1px solid #ccc; background: white; color: #333; }
        
        .item-row-control {
            background: #f1f2f6; padding: 10px; border-radius: 5px; margin-bottom: 8px; position: relative; border-right: 3px solid var(--primary);
        }
        .btn-remove { position: absolute; top: 5px; left: 5px; color: #ff4757; cursor: pointer; font-size: 18px; }

        /* --- پیش‌نمایش فاکتور --- */
        main.preview-area {
            flex: 1; overflow-y: auto; padding: 30px; display: flex; justify-content: center; align-items: flex-start;
        }

        .paper {
            width: 210mm; min-height: 297mm; background: white; padding: 10mm;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); position: relative; box-sizing: border-box;
        }

        /* --- المان‌های داخل کاغذ --- */
        .invoice-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        .logo-box { width: 100px; height: 80px; display: flex; align-items: center; justify-content: center; }
        .logo-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        .inv-title { text-align: center; flex: 1; }
        .inv-title h1 { margin: 0; font-size: 20px; color: var(--primary); font-weight: 800; }
        .inv-details { font-size: 11px; line-height: 1.8; text-align: left; width: 150px; }

        .box-section { border: 1px solid #000; margin-bottom: 5px; border-radius: 4px; overflow: hidden; }
        .box-header { background: #dfe4ea; font-size: 11px; font-weight: bold; padding: 4px 8px; border-bottom: 1px solid #000; text-align: center; }
        .box-content { padding: 5px; }

        .inv-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .inv-table th, .inv-table td { border: 1px solid #000; padding: 4px; text-align: center; vertical-align: middle; }
        .inv-table th { background: #dfe4ea; font-weight: bold; }
        
        .no-border { border: none !important; }
        .text-right { text-align: right !important; }
        .font-bold { font-weight: bold; }
        
        .totals-wrapper { display: flex; justify-content: flex-end; margin-top: 0; }
        .totals-table { width: 40%; border-collapse: collapse; font-size: 11px; }
        .totals-table td { border: 1px solid #000; padding: 5px; }
        
        .final-words { margin-top: 10px; padding: 8px; border: 1px solid #000; background: #f1f2f6; font-size: 12px; font-weight: bold; border-radius: 4px; }

        .signatures { margin-top: 30px; display: flex; justify-content: space-between; }
        .sig-box { width: 48%; height: 90px; border: 1px solid #000; padding: 5px; font-size: 11px; font-weight: bold; border-radius: 4px; }

        /* --- تنظیمات چاپ --- */
        @media print {
            body { background: white; height: auto; overflow: visible; }
            aside.sidebar { display: none !important; }
            main.preview-area { padding: 0; display: block; height: auto; overflow: visible; }
            .paper { width: 100%; height: auto; box-shadow: none; margin: 0; padding: 0; border: none; }
            @page { size: A4; margin: 10mm; }
            .box-header, .inv-table th, .final-words { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">
            <h3>تنظیمات فاکتور</h3>
            <div style="font-size: 10px; opacity: 0.8;">نسخه نهایی</div>
        </div>
        <div class="sidebar-content">
            
            <details open>
                <summary>ظاهر و برندینگ <span class="material-icons" style="font-size:16px">palette</span></summary>
                <div class="details-body">
                    <div class="form-group">
                        <label>رنگ سازمانی:</label>
                        <input type="color" id="inp_color" value="#2c3e50" onchange="updateTheme()">
                    </div>
                    <div class="form-group">
                        <label>لوگو (انتخاب تصویر):</label>
                        <input type="file" id="inp_logo" accept="image/*" onchange="uploadLogo(this)">
                        <button class="btn btn-outline btn-block" onclick="removeLogo()" style="margin-top:5px; font-size:10px;">حذف لوگو</button>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="inp_tax" onchange="render()"> محاسبه ۹٪ ارزش افزوده
                        </label>
                    </div>
                </div>
            </details>

            <details>
                <summary>مشخصات عمومی <span class="material-icons" style="font-size:16px">info</span></summary>
                <div class="details-body">
                    <div class="row">
                        <div class="col"><label>سریال</label><input type="text" id="inp_serial" oninput="save()"></div>
                        <div class="col"><label>تاریخ</label><input type="text" id="inp_date" value="1404/01/01" oninput="save()"></div>
                    </div>
                </div>
            </details>

            <details>
                <summary>مشخصات فروشنده <span class="material-icons" style="font-size:16px">store</span></summary>
                <div class="details-body">
                    <div class="form-group"><label>نام شخص/شرکت</label><input type="text" id="inp_s_name" oninput="save()"></div>
                    <div class="row">
                        <div class="col"><label>کد اقتصادی</label><input type="text" id="inp_s_eco" oninput="save()"></div>
                        <div class="col"><label>شناسه ملی</label><input type="text" id="inp_s_nat" oninput="save()"></div>
                    </div>
                    <div class="row">
                        <div class="col"><label>کد پستی</label><input type="text" id="inp_s_zip" oninput="save()"></div>
                        <div class="col"><label>تلفن</label><input type="text" id="inp_s_tel" oninput="save()"></div>
                    </div>
                    <div class="form-group"><label>آدرس</label><textarea rows="2" id="inp_s_addr" oninput="save()"></textarea></div>
                </div>
            </details>

            <details>
                <summary>مشخصات خریدار <span class="material-icons" style="font-size:16px">person</span></summary>
                <div class="details-body">
                    <div class="form-group"><label>نام شخص/شرکت</label><input type="text" id="inp_b_name" oninput="save()"></div>
                    <div class="row">
                        <div class="col"><label>کد اقتصادی</label><input type="text" id="inp_b_eco" oninput="save()"></div>
                        <div class="col"><label>شناسه ملی</label><input type="text" id="inp_b_nat" oninput="save()"></div>
                    </div>
                    <div class="row">
                        <div class="col"><label>کد پستی</label><input type="text" id="inp_b_zip" oninput="save()"></div>
                        <div class="col"><label>تلفن</label><input type="text" id="inp_b_tel" oninput="save()"></div>
                    </div>
                    <div class="form-group"><label>آدرس</label><textarea rows="2" id="inp_b_addr" oninput="save()"></textarea></div>
                </div>
            </details>

            <details open>
                <summary>اقلام فاکتور <span class="material-icons" style="font-size:16px">shopping_cart</span></summary>
                <div class="details-body" id="items_control_container"></div>
                <div style="padding: 10px;">
                    <button class="btn btn-primary btn-block" onclick="addItem()">
                        <span class="material-icons" style="font-size:16px">add</span> افزودن سطر جدید
                    </button>
                </div>
            </details>

            <div style="margin-top: auto; padding: 15px; border-top: 1px solid #ccc; background: #fafafa;">
                <div class="row" style="margin-bottom: 10px;">
                    <button class="btn btn-outline col" onclick="exportData()">ذخیره فایل</button>
                    <button class="btn btn-outline col" onclick="document.getElementById('import_file').click()">بازکردن فایل</button>
                    <input type="file" id="import_file" style="display:none" accept=".json" onchange="importData(this)">
                </div>
                <div class="row">
                    <button class="btn btn-danger col" onclick="resetAll()">پاکسازی</button>
                    <button class="btn btn-success col" onclick="window.print()">چاپ / PDF</button>
                </div>
            </div>
        </div>
    </aside>

    <main class="preview-area">
        <div class="paper" id="invoice_paper">
            <div class="invoice-header">
                <div class="logo-box" id="out_logo_box"><span style="font-size:10px; color:#ccc;">محل لوگو</span></div>
                <div class="inv-title"><h1>صورتحساب فروش کالا و خدمات</h1></div>
                <div class="inv-details">
                    شماره سریال: <span id="out_serial" class="font-bold"></span><br>
                    تاریخ صدور: <span id="out_date" class="font-bold"></span>
                </div>
            </div>

            <div class="box-section">
                <div class="box-header">مشخصات فروشنده</div>
                <div class="box-content">
                    <table style="width:100%; font-size:11px;">
                        <tr>
                            <td class="no-border text-right" style="width:50%">نام: <span id="out_s_name" class="font-bold"></span></td>
                            <td class="no-border text-right">ش.اقتصادی: <span id="out_s_eco"></span></td>
                            <td class="no-border text-right">ش.ملی: <span id="out_s_nat"></span></td>
                        </tr>
                        <tr><td class="no-border text-right" colspan="3">نشانی: <span id="out_s_addr"></span></td></tr>
                        <tr>
                            <td class="no-border text-right">کد پستی: <span id="out_s_zip"></span></td>
                            <td class="no-border text-right" colspan="2">تلفن: <span id="out_s_tel"></span></td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="box-section">
                <div class="box-header">مشخصات خریدار</div>
                <div class="box-content">
                    <table style="width:100%; font-size:11px;">
                        <tr>
                            <td class="no-border text-right" style="width:50%">نام: <span id="out_b_name" class="font-bold"></span></td>
                            <td class="no-border text-right">ش.اقتصادی: <span id="out_b_eco"></span></td>
                            <td class="no-border text-right">ش.ملی: <span id="out_b_nat"></span></td>
                        </tr>
                        <tr><td class="no-border text-right" colspan="3">نشانی: <span id="out_b_addr"></span></td></tr>
                        <tr>
                            <td class="no-border text-right">کد پستی: <span id="out_b_zip"></span></td>
                            <td class="no-border text-right" colspan="2">تلفن: <span id="out_b_tel"></span></td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="box-section" style="border:none;">
                <div class="box-header" style="border:1px solid #000;">مشخصات کالا یا خدمات مورد معامله</div>
                <table class="inv-table">
                    <thead>
                        <tr>
                            <th style="width:5%">ردیف</th>
                            <th>شرح کالا / خدمات</th>
                            <th style="width:8%">تعداد</th>
                            <th style="width:14%">مبلغ واحد (ریال)</th>
                            <th style="width:14%">مبلغ کل (ریال)</th>
                            <th style="width:10%">تخفیف</th>
                            <th style="width:14%">مبلغ خالص</th>
                        </tr>
                    </thead>
                    <tbody id="out_tbody"></tbody>
                </table>
            </div>

            <div class="totals-wrapper">
                <table class="totals-table">
                    <tr id="row_tax" style="display:none; background:#f1f2f6;">
                        <td class="text-right font-bold">جمع مالیات و عوارض (۹٪)</td>
                        <td class="text-center"><span id="out_tax_val">0</span></td>
                    </tr>
                    <tr style="background:#dfe4ea;">
                        <td class="text-right font-bold" style="font-size:12px;">جمع کل قابل پرداخت</td>
                        <td class="text-center font-bold" style="font-size:12px;"><span id="out_final_val">0</span></td>
                    </tr>
                </table>
            </div>

            <div class="final-words">
                مبلغ قابل پرداخت به حروف: <span id="out_words_text" style="font-weight:normal; margin-right:5px;"></span> ریال
            </div>

            <div class="signatures">
                <div class="sig-box">مهر و امضاء فروشنده:</div>
                <div class="sig-box">مهر و امضاء خریدار:</div>
            </div>
            
            <div style="margin-top:20px; font-size:10px; text-align:center; border-top:1px dashed #ccc; padding-top:5px;">
                این فاکتور به صورت سیستمی صادر شده است.
            </div>
        </div>
    </main>

    <script>
        let state = { config: { color: '#2c3e50', tax: false, logo: null }, fields: {}, items: [] };
        const fieldIds = ['serial','date','s_name','s_eco','s_nat','s_tel','s_zip','s_addr','b_name','b_eco','b_nat','b_tel','b_zip','b_addr'];

        function init() {
            const loaded = localStorage.getItem('invoice_v4_final');
            if (loaded) try { state = JSON.parse(loaded); } catch(e){}
            else addItem(false);
            
            document.getElementById('inp_color').value = state.config.color || '#2c3e50';
            document.getElementById('inp_tax').checked = state.config.tax || false;
            updateTheme();

            fieldIds.forEach(id => {
                const el = document.getElementById('inp_' + id);
                if(el) el.value = state.fields[id] || '';
            });
            renderSidebarItems();
            render();
        }

        function save() {
            fieldIds.forEach(id => {
                const el = document.getElementById('inp_' + id);
                if(el) state.fields[id] = el.value;
            });
            state.config.color = document.getElementById('inp_color').value;
            state.config.tax = document.getElementById('inp_tax').checked;
            localStorage.setItem('invoice_v4_final', JSON.stringify(state));
            render();
        }

        function addItem(shouldSave = true) {
            state.items.push({ desc: '', qty: 1, price: 0, disc: 0 });
            if(shouldSave) { renderSidebarItems(); save(); }
        }
        function removeItem(index) {
            if(confirm('حذف شود؟')) { state.items.splice(index, 1); renderSidebarItems(); save(); }
        }
        function updateItem(index, key, val) {
            state.items[index][key] = val; save();
        }

        function renderSidebarItems() {
            const container = document.getElementById('items_control_container');
            container.innerHTML = '';
            state.items.forEach((item, idx) => {
                const html = `
                <div class="item-row-control">
                    <span class="btn-remove material-icons" onclick="removeItem(${idx})">close</span>
                    <div style="margin-right:25px;">
                        <div class="form-group"><input type="text" placeholder="شرح کالا" value="${item.desc}" oninput="updateItem(${idx}, 'desc', this.value)"></div>
                        <div class="row">
                            <div class="col"><input type="number" placeholder="تعداد" value="${item.qty}" oninput="updateItem(${idx}, 'qty', parseFloat(this.value))"></div>
                            <div class="col"><input type="number" placeholder="مبلغ واحد" value="${item.price}" oninput="updateItem(${idx}, 'price', parseFloat(this.value))"></div>
                        </div>
                        <div class="form-group"><input type="number" placeholder="تخفیف" value="${item.disc}" oninput="updateItem(${idx}, 'disc', parseFloat(this.value))"></div>
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function render() {
            fieldIds.forEach(id => {
                const el = document.getElementById('out_' + id);
                if(el) el.innerText = toPersian(state.fields[id]);
            });
            const logoBox = document.getElementById('out_logo_box');
            logoBox.innerHTML = state.config.logo ? `<img src="${state.config.logo}">` : `<span style="font-size:10px; color:#ccc;">محل لوگو</span>`;

            const tbody = document.getElementById('out_tbody');
            tbody.innerHTML = '';
            let sumTotal = 0;

            state.items.forEach((item, i) => {
                const qty = item.qty || 0;
                const price = item.price || 0;
                const disc = item.disc || 0;
                const rawTotal = qty * price;
                const finalRow = rawTotal - disc;
                sumTotal += finalRow;

                const tr = `<tr><td>${toPersian(i+1)}</td><td class="text-right">${item.desc}</td><td>${toPersian(qty)}</td><td>${toPersian(formatMoney(price))}</td><td>${toPersian(formatMoney(rawTotal))}</td><td>${toPersian(formatMoney(disc))}</td><td>${toPersian(formatMoney(finalRow))}</td></tr>`;
                tbody.insertAdjacentHTML('beforeend', tr);
            });

            let finalPay = sumTotal;
            if (state.config.tax) {
                const tax = Math.round(sumTotal * 0.09);
                finalPay += tax;
                document.getElementById('row_tax').style.display = 'table-row';
                document.getElementById('out_tax_val').innerText = toPersian(formatMoney(tax));
            } else {
                document.getElementById('row_tax').style.display = 'none';
            }
            document.getElementById('out_final_val').innerText = toPersian(formatMoney(finalPay));
            document.getElementById('out_words_text').innerText = numToPersianWords(finalPay);
        }

        function toPersian(str) { if (str == null) return ''; return str.toString().replace(/[0-9]/g, w => "۰۱۲۳۴۵۶۷۸۹"[w]); }
        function formatMoney(n) { return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
        function updateTheme() { document.documentElement.style.setProperty('--primary', document.getElementById('inp_color').value); render(); }
        function uploadLogo(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { state.config.logo = e.target.result; save(); }; reader.readAsDataURL(input.files[0]); } }
        function removeLogo() { state.config.logo = null; document.getElementById('inp_logo').value = ''; save(); }
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const anchor = document.createElement('a');
            anchor.setAttribute("href", dataStr); anchor.setAttribute("download", "invoice.json");
            document.body.appendChild(anchor); anchor.click(); anchor.remove();
        }
        function importData(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) { try { state = JSON.parse(e.target.result); localStorage.setItem('invoice_v4_final', JSON.stringify(state)); location.reload(); } catch(err) { alert('فایل نامعتبر'); } };
                reader.readAsText(input.files[0]);
            }
        }
        function resetAll() { if(confirm('پاک شود؟')){ localStorage.removeItem('invoice_v4_final'); location.reload(); } }

        function numToPersianWords(number) {
            if (number === 0) return 'صفر';
            const nav=['','یک','دو','سه','چهار','پنج','شش','هفت','هشت','نه'], dah=['','ده','بیست','سی','چهل','پنجاه','شصت','هفتاد','هشتاد','نود'], sad=['','صد','دویست','سیصد','چهارصد','پانصد','ششصد','هفتصد','هشتصد','نهصد'], ten_twenty=['ده','یازده','دوازده','سیزده','چهارده','پانزده','شانزده','هفده','هجده','نوزده'], units=['','هزار','میلیون','میلیارد','تریلیون'];
            let str=number.toString(), chunks=[]; while(str.length>0){ chunks.push(str.slice(-3)); str=str.slice(0,-3); }
            let words=[]; for(let i=0;i<chunks.length;i++){
                let n=parseInt(chunks[i]); if(n===0) continue;
                let chunkWords=[], d1=Math.floor(n/100), d2=Math.floor((n%100)/10), d3=n%10;
                if(d1>0) chunkWords.push(sad[d1]);
                if(d2===1) chunkWords.push(ten_twenty[d3]); else { if(d2>0) chunkWords.push(dah[d2]); if(d3>0) chunkWords.push(nav[d3]); }
                let w=chunkWords.join(' و '); if(i>0) w+=' '+units[i]; words.push(w);
            }
            return words.reverse().join(' و ');
        }

        window.onload = init;
    </script>
</body>
</html>
